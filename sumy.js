const Telegraf = require('telegraf')
const mysql = require('mysql')
const bot = new Telegraf('1476094317:AAGIpgPHxF5XdA_4YbaSDkJUsDDpsmUiSBA')

const conn = mysql.createConnection({
    host: "server222.hosting.reg.ru",
    user: "u0613437_ecosumy",
    database: "u0613437_ecosumy",
    password: "Lock2612"
});
var globLat = 0;
var globLon = 0;
let items = ['üîã –ë–∞—Ç–∞—Ä–µ–π–∫–∏ üîã', 'üìö –ú–∞–∫—É–ª–∞—Ç—É—Ä–∞ üìö', '‚öôÔ∏è –ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç ‚öôÔ∏è', 'üî¥ –ü–ª–∞—Å—Ç–∏–∫–æ–≤—ñ –∫—Ä–∏—à–µ—á–∫–∏ üî¥', 'üçæ –°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏ üçæ', 'üí° –õ—é–º—ñ–Ω—ñ—Å—Ü–µ–Ω—Ç–Ω—ñ –ª–∞–º–ø–∏ üí°'];

ids = [];
ids[1] = { name: '–≤—É–ª –°–æ–±–æ—Ä–Ω–∞, 36', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.910273766825014', lng: '34.800560785319476', photo: '', description: '¬´Platinum Bank¬ª'};
ids[2] = { name: '–≤—É–ª. –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞, 1', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.90968249999999', lng: '34.79609161045073', photo: '', description: '–ú–µ—Ä–µ–∂–∞ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ ¬´Watsons¬ª. –¢–µ–ª.: +380 542 215 990'};
ids[3] = { name: '–≤—É–ª. –ù–∞–±–µ—Ä–µ–∂–Ω–∞ —Ä. –°—Ç—Ä—ñ–ª–∫–∏, 46', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.9016181', lng: '34.7763816', photo: '', description: '–ú–∞–≥–∞–∑–∏–Ω ¬´CompService¬ª, 1–π –ø–æ–≤–µ—Ä—Ö'};
ids[4] = { name: '–≤—É–ª. –ü–µ—Ç—Ä–æ–ø–∞–≤–ª—ñ–≤—Å—å–∫–∞, 81', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.9010960', lng: '34.7903550', photo: '', description: '–ú–µ—Ä–µ–∂–∞ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ ¬´Watsons¬ª. –¢–µ–ª: +380 542 655 285'};
ids[5] = { name: '–õ–µ–≤–∞–Ω–µ–≤—Å—å–∫–æ–≥–æ, 22', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.92192473127266', lng: '34.81277644246677', photo: '', description: '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: –ê–¢–ë-–ú–∞—Ä–∫–µ—Ç. –ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: putnick@list.ru. '};
ids[6] = { name: '–ø–ª–æ—â–∞ –ü–æ–∫—Ä–æ–≤—Å—å–∫–∞, 3', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.906680524618515', lng: '34.79661063194658', photo: '', description: '–ú–µ—Ä–µ–∂–∞ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ ¬´Watsons¬ª. –¢–µ–ª: +380 542 781 927'};
ids[7] = { name: '–ø—Ä–æ—Å–ø. –ú–∏—Ö–∞–π–ª–∞ –õ—É—à–ø–∏, 4/1', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.9047141', lng: '34.8195684', photo: '', description: '–ú–µ—Ä–µ–∂–∞ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ ¬´Watsons¬ª. –¢–µ–ª: +380 542 700 881'};
ids[8] = { name: '–ø—Ä–æ—Å–ø. –ú–∏—Ö–∞–π–ª–∞ –õ—É—à–ø–∏, 46', type: '–ë–∞—Ç–∞—Ä–µ–π–∫–∏', lat: '50.9153870', lng: '34.8321960', photo: '', description: '–ú–µ—Ä–µ–∂–∞ –º–∞–≥–∞–∑–∏–Ω—ñ–≤ ¬´Watsons¬ª. –¢–µ–ª: +380 542 604 360'};
ids[9] = { name: '–≤—É–ª. –ù–∞–±–µ—Ä–µ–∂–Ω–∞ —Ä. –°—Ç—Ä—ñ–ª–∫–∏, 46', type: '–õ—é–º—ñ–Ω—ñ—Å—Ü–µ–Ω—Ç–Ω—ñ –ª–∞–º–ø–∏', lat: '50.9016181', lng: '34.7763816', photo: '', description: '–¢–û–í –ù–í–ü ¬´–ï–∫–æ—Å—Ç–∞–Ω–¥–∞—Ä—Ç¬ª, 3 –ø–æ–≤–µ—Ä—Ö, –æ—Ñ—ñ—Å 9, —Ç–µ–ª .: (054) 279-09-67'};
ids[10] = { name: '–≤—É–ª. –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞, 78', type: '–õ—é–º—ñ–Ω—ñ—Å—Ü–µ–Ω—Ç–Ω—ñ –ª–∞–º–ø–∏', lat: '49.8459819', lng: '36.6743886', photo: '', description: '–¢–û–í ¬´–ü—Ä–æ–º—Ç–µ—Ö—Å–ø–ª–∞–≤¬ª, —Ç–µ–ª: 726-808'};
ids[11] = { name: '–≤—É–ª–∏—Ü—è –°–∫—Ä—è–±—ñ–Ω–∞, 38', type: '–õ—é–º—ñ–Ω—ñ—Å—Ü–µ–Ω—Ç–Ω—ñ –ª–∞–º–ø–∏', lat: '50.9395287', lng: '34.8013892', photo: '', description: '–¢–û–í ¬´–°–ø–µ—Ü–∑–∞—Ö–∏—Å—Ç¬ª, —Ç–µ–ª: 786-702'};
ids[12] = { name: '–≤—É–ª. –ö—É—Ä—Å—å–∫–∞, 147', type: '–ú–∞–∫—É–ª–∞—Ç—É—Ä–∞', lat: '50.94814928750786', lng: '34.772766168786575', photo: '', description: '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: –ß–ü ¬´–°–æ–ª–¥–∞—Ç–µ–Ω–∫–æ¬ª. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ: +380 (495) 844-91-28. –ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: dorosh-nika@mail.ru.'};
ids[13] = { name: '–≤—É–ª. –ß–µ—Ä–∫–∞—Å—å–∫–∞, 4', type: '–ú–∞–∫—É–ª–∞—Ç—É—Ä–∞', lat: '50.89811216759916', lng: '34.84306641964338', photo: '', description: '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: –°–í–û–î. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ: +38066429-33-16 . –ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: dorosh-nika@mail.ru.'};
ids[14] = { name: '–ø-—Ç. –ö—É—Ä—Å—å–∫–∏–π, 14', type: '–ú–∞–∫—É–ª–∞—Ç—É—Ä–∞', lat: '50.93620145144488', lng: '34.78666131282807', photo: '', description: '–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: –¢–û–í ¬´–≠–∫–æ–≥—Ä—É–ø–ø –°–ü¬ª. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ: (050) 307-37-68. –ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: yana.ihnenko@yandex.ru. '};
ids[15] = { name: '1-–∞ –ó–∞–ª—ñ–∑–Ω–∏—á–Ω–∞ –≤—É–ª–∏—Ü—è, 2', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.93002249416598', lng: '34.80858709405675', photo: '', description: '¬´–Ñ–≤—Ä–æ—Ä–µ—Å—É—Ä—Å–∏¬ª. –¢–µ–ª.: +380 (536) 66-02-78'};
ids[16] = { name: '2-–∞ –ó–∞–ª—ñ–∑–Ω–∏—á–Ω–∞ –≤—É–ª–∏—Ü—è, 2', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.9278900', lng: '34.8210830', photo: '', description: '¬´–Ñ–≤—Ä–æ—Ä–µ—Å—É—Ä—Å¬ª, —Ç–µ–ª. (0542) 254-105'};
ids[17] = { name: '–≤—É–ª. –í–æ—î–≤–æ–¥—ñ–Ω–∞, 8', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.8838040', lng: '34.8629960', photo: '', description: '¬´–°—É–º—ã—ç–∫–æ—Ä–µ—Å—É—Ä—Å—ã¬ª. –¢–µ–ª.: +380 (48) 766-41-83, +380 (48) 766-46-11, info@uecr.gov.ua, http://uecr.gov.ua'};
ids[18] = { name: '–≤—É–ª. –ì–µ—Ä–æ—ó–≤ –ö—Ä—É—Ç, 19', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.9105300', lng: '34.8417280', photo: '', description: '–¢–û–í ¬´–ú–ï–¢–ê¬ª, —Ç–µ–ª. (098) 20-46-872, (066) 99-44-197, –û–ª–µ–∫—Å–∞–Ω–¥—Ä –í–∞—Å–∏–ª—å–æ–≤–∏—á'};
ids[19] = { name: '–≤—É–ª. –ö–æ—Å—ñ–≤—â–∏–Ω—Å—å–∫–∞, 18', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.9133720', lng: '34.7671050', photo: '', description: '–ö–æ–º–ø–∞–Ω—ñ—è ¬´–ú–µ—Ç–∞–ª–ª—Å–µ—Ä–≤–∏—Å¬ª. –¢–µ–ª: +380 (48) 750-49-73, +380 (48) 750-49-75'};
ids[20] = { name: '–≤—É–ª. –ö–æ—Å—ñ–≤—â–∏–Ω—Å—å–∫–∞, 18', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.9133720', lng: '34.7671050', photo: '', description: '–ö–æ–º–ø–∞–Ω–∏—è ¬´–ú–µ—Ç–∞–ª–ª—Å–µ—Ä–≤–∏—Å¬ª. –¢–µ–ª: 048 750 4973, 048 750 4975'};
ids[21] = { name: '–≤—É–ª. –¢–æ–ø–æ–ª—è–Ω—Å—å–∫–∞, 13', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.9300760', lng: '34.8119880', photo: '', description: '¬´–°—É–º—ã–≤—Ç–æ—Ä–º–µ—Ç¬ª. –¢–µ–ª.: +380 (4853) 3-22-60, glavbuh@fort.sumy.ua'};
ids[22] = { name: '–ø–ª–æ—â–∞ –ù–µ–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, 3', type: '–ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç', lat: '50.91123080250144', lng: '34.80375768406145', photo: '', description: '¬´–£–∫—Ä–µ–∫–æ–∫–æ–º—Ä–µ—Å—É—Ä—Å—ã¬ª. –¢–µ–ª.: +380 (5366) 6-11-02, +380 (536) 76-09-16, +380 (53'};
ids[23] = { name: '–≤—É–ª. 20-—Ä—ñ—á—á—è –ü–µ—Ä–µ–º–æ–≥–∏, 9', type: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ñ –∫—Ä–∏—à–µ—á–∫–∏', lat: '50.8947100', lng: '34.7799750', photo: '', description: '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—å–∫–∏–π —Ü–µ–Ω—Ç—Ä –°–ë–ë. –ü—É–Ω–∫—Ç –∑–±–æ—Ä—É —Ä–æ–∑–º—ñ—â–µ–Ω–æ –∑–∞–≤–¥—è–∫–∏ –ë–§ ¬´–û–í–ï–°¬ª (owesua.org).'};
ids[24] = { name: '–≤—É–ª. –†–∏–º—Å—å–∫–æ–≥–æ-–ö–æ—Ä—Å–∞–∫–æ–≤–∞, 2', type: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ñ –∫—Ä–∏—à–µ—á–∫–∏', lat: '50.89252744660538', lng: '34.840000449737545', photo: '', description: '–ü—É–Ω–∫—Ç –∑–±–æ—Ä—É —Ä–æ–∑–º—ñ—â–µ–Ω–æ –∑–∞–≤–¥—è–∫–∏ –ë–§ ¬´–û–í–ï–°¬ª (owesua.org).'};
ids[25] = { name: '–ø—Ä–æ—Å–ø. –¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞, 21', type: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ñ –∫—Ä–∏—à–µ—á–∫–∏', lat: '50.9161878', lng: '34.8063886', photo: '', description: '–ü—É–Ω–∫—Ç –∑–±–æ—Ä—É —Ä–æ–∑–º—ñ—â–µ–Ω–æ –∑–∞–≤–¥—è–∫–∏ –ë–§ ¬´–û–í–ï–°¬ª (owesua.org).'};
ids[26] = { name: '–≤—É–ª. –ë–∞—Ä–∞–Ω—ñ–≤—Å—å–∫–∞, 11', type: '–°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏', lat: '50.939172459673934', lng: '34.83555515134276', photo: '', description: '–ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: dorosh-nika@mail.ru.'};
ids[27] = { name: '–≤—É–ª. –î–æ–≤–∞—Ç–æ—Ä–∞, 1', type: '–°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏', lat: '50.93859828494334', lng: '34.83446159391781', photo: '', description: '–ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: dorosh-nika@mail.ru.'};
ids[28] = { name: '–Ü–Ω—Ç–µ—Ä–Ω–∞—Ü—ñ–æ–Ω–∞–ª—ñ—Å—Ç—ñ–≤, 14', type: '–°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏', lat: '50.910435352649905', lng: '34.82847382209013', photo: '', description: '–ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: d.ryazantseva@physgeo.com. '};
ids[29] = { name: '–Ü–Ω—Ç–µ—Ä–Ω–∞—Ü—ñ–æ–Ω–∞–ª—ñ—Å—Ç—ñ–≤, 18', type: '–°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏', lat: '50.90940489905698', lng: '34.82902409325402', photo: '', description: '–ú–µ–π–ª –ª—é–¥–∏–Ω–∏, —â–æ –¥–æ–¥–∞–ª–∞ –ø—É–Ω–∫—Ç: d.ryazantseva@physgeo.com.'};



bot.start((ctx) => {
    var user =
        [
        ctx.from.id,
        ctx.from.first_name,
        ctx.from.last_name,
        ctx.from.username
        ]
    var sql = "INSERT INTO users(id, first_name, last_name, username) VALUES(?,?,?,?)"
    conn.query(sql, user, function(err, results) {
        if(err) console.log(err);
        else console.log("–î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
    });
    ctx.reply("–ü—Ä–∏–≤—ñ—Ç!");
    return ctx.reply("–î–ª—è –ø–æ—á–∞—Ç–∫—É - –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –≤–∞—à—É –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.")
})
bot.on('location', (ctx) => {
    console.log(ctx.message.location.latitude + " " + ctx.message.location.longitude)
    globLon = ctx.message.location.longitude
    globLat = ctx.message.location.latitude
    var userData =
        [
            ctx.from.first_name,
            ctx.from.last_name,
            ctx.from.username,
            ctx.message.location.latitude,
            ctx.message.location.longitude
        ]
    var sql = "INSERT INTO messages(first_name, last_name, username, latitude, longitude) VALUES(?,?,?,?,?)"
    conn.query(sql, userData, function(err, results) {
        if(err) console.log(err);
        else console.log("–î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã");
    });
    bot.telegram.sendMessage(ctx.chat.id,'–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥—Ö–æ–¥–∏', {
        reply_markup:{
            keyboard:[
                ['üîã –ë–∞—Ç–∞—Ä–µ–π–∫–∏ üîã'],
                ['üìö –ú–∞–∫—É–ª–∞—Ç—É—Ä–∞ üìö'],
                ['‚öôÔ∏è –ú–µ—Ç–∞–ª–æ–±—Ä—É—Ö—Ç ‚öôÔ∏è'],
                ['üî¥ –ü–ª–∞—Å—Ç–∏–∫–æ–≤—ñ –∫—Ä–∏—à–µ—á–∫–∏ üî¥'],
                ['üçæ –°–∫–ª—è–Ω—ñ –ø–ª—è—à–∫–∏ üçæ'],
                ['üí° –õ—é–º—ñ–Ω—ñ—Å—Ü–µ–Ω—Ç–Ω—ñ –ª–∞–º–ø–∏ üí°']
            ]
        }
    })
})
bot.on("message", ctx => {
    if(items.includes(ctx.message.text)){
        var minlength = 10000000;
        var savedIndex = 0;
        if(globLat === 0 || globLon === 0){
            ctx.reply("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é")
        }else {
            for(i = 1; i <= 29; i++){
                if(ctx.message.text.includes(ids[i]['type'])) {
                    var templength = Math.sqrt(Math.pow(ids[i]['lat'] - globLat, 2) + Math.pow(ids[i]['lng'] - globLon, 2))
                    if (templength < minlength) {
                        minlength = templength;
                        savedIndex = i;
                    }
                }
            }
           return ctx.reply("–ó–¥–∞—Ç–∏ " + ids[savedIndex]['type'] + " –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞ –∞–¥—Ä–µ—Å–æ—é: " + ids[savedIndex]['name'] + ".\n–î—è–∫—É—î–º–æ, —â–æ –ø—ñ–∫–ª—É—î—Ç–µ—Å—å –ø—Ä–æ –Ω–∞—à–µ –¥–æ–≤–∫—ñ–ª–ª—è ‚ù§Ô∏è")
        }
    }
})
bot.startPolling()